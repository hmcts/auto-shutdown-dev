name: Update Dashboard Data
run-name: Update dashboard data with latest GitHub metadata

on:
  schedule:
    # Run daily at 5 AM UTC to refresh data with latest GitHub metadata
    - cron: '00 05 * * *'
  issues:
    # Also run when issues are created, updated, or labeled to keep data fresh
    types: [opened, edited, labeled, closed]
  workflow_dispatch:

env:
  GH_TOKEN: ${{ secrets.PLATFORM_USER_TOKEN }}

permissions:
  id-token: write
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    if: github.event_name != 'issues' || (github.event.issue.user.login != 'renovate[bot]' && github.actor != 'hmcts-platform-operations' && !contains(github.event.issue.labels.*.name, 'pull-request'))
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'
          token: ${{ env.GH_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python Requirements
        run: |
          pip3 install -r requirements.txt

      - name: Generate Enhanced Dashboard Data
        run: |
          python ./scripts/generate_dashboard_data.py

      - name: Commit updated data
        run: |
          git config user.name hmcts-platform-operations
          git config user.email github-platform-operations@hmcts.net
          
          # Check if there are any changes to commit
          if ! git diff --quiet; then
            git add issues_list.json docs/issues_list.json
            git commit -m "Update dashboard data with latest GitHub metadata" || echo "No changes to commit"
            git push || echo "No changes to push"
            echo "Dashboard data updated successfully"
          else
            echo "No changes detected in dashboard data"
          fi